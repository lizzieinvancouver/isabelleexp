## Started 14 October 2024
## By Lizzie

## What this code does ...
Following analyses_compmod_exp2.R some 
Using Stan and loo to do similar model comparison as Isabelle did in Scripts__expe2_model_comparison.R 
See https://mc-stan.org/loo/articles/loo2-example.html for info on loo ##
I have not fully reviewed the above page, I am mostly just following what I did in analyses_compmod_exp2.R ##

```{r}
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
```

Load libraries
```{r}
library(rstanarm)
```

Get the data
```{r}
setwd("~/Documents/git/projects/treegarden/misc/isabelle_expe/modelcompare")
d <- read.delim("input/data_expe2_v5.csv", header=TRUE, sep=";")
betula <- subset(d, Species=="Betula")
```

Run all the single predictor models 
```{r}
betula.null <- stan_lmer(BBdelay ~ (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.day <- stan_lmer(BBdelay ~ DayT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.night <- stan_lmer(BBdelay ~ NightT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.max <- stan_lmer(BBdelay ~ MaxT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.min <- stan_lmer(BBdelay ~ MinT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.dawn <- stan_lmer(BBdelay ~ DawnT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.dusk <- stan_lmer(BBdelay ~ DuskT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.diff <- stan_lmer(BBdelay ~ DIFF + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.mean <- stan_lmer(BBdelay ~  MeanT + (1|Tree_ID/Cutting_code), data=betula, cores=4)

loo.betula.null <- loo(betula.null, save_psis = TRUE, k_threshold = 0.7)
loo.betula.day <- loo(betula.day, save_psis = TRUE, k_threshold = 0.7)
loo.betula.night <- loo(betula.night, save_psis = TRUE, k_threshold = 0.7)
loo.betula.max <- loo(betula.max, save_psis = TRUE, k_threshold = 0.7)
loo.betula.min <- loo(betula.min, save_psis = TRUE, k_threshold = 0.7)
loo.betula.dawn <- loo(betula.dawn, save_psis = TRUE, k_threshold = 0.7)
loo.betula.dusk <- loo(betula.dusk, save_psis = TRUE, k_threshold = 0.7)
loo.betula.diff <- loo(betula.diff, save_psis = TRUE, k_threshold = 0.7)
loo.betula.mean <- loo(betula.mean, save_psis = TRUE, k_threshold = 0.7)
```

```{r}
loo_compare(loo.betula.null, loo.betula.day, loo.betula.night, loo.betula.max,
	loo.betula.min, loo.betula.dawn, loo.betula.dusk, loo.betula.diff, loo.betula.mean) 
```
The above works, we don't need the pairwise comparisons ...
but leaving these in to show that:

```{r}
loo_compare(loo.betula.null, loo.betula.max) 
loo_compare(loo.betula.null, loo.betula.diff) 
```

Now check what seems to matter and run additional models
I am looking at estimate versus SD and also the 10-90% intervals

```{r}
summary(betula.day, pars="DayT") # marginal to ns
summary(betula.night, pars="NightT") # impt
summary(betula.max, pars="MaxT") # impt
summary(betula.min, pars="MinT") # marginal to ns
summary(betula.dawn, pars="DawnT") # impt
summary(betula.dusk, pars="DuskT") # impt
summary(betula.diff, pars="DIFF") # impt
summary(betula.mean, pars="MeanT") # impt
```
And look at the models with multiple predictors
```{r}
betula.meanmax <- stan_lmer(BBdelay ~ MaxT + MeanT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.maxdiff <- stan_lmer(BBdelay ~ MaxT + DIFF + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.diffdawn <- stan_lmer(BBdelay ~  DawnT + DIFF + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.dawndusk <- stan_lmer(BBdelay ~  DawnT + DuskT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.diffdusk <- stan_lmer(BBdelay ~  DIFF + DuskT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.maxdawn <- stan_lmer(BBdelay ~  MaxT + DawnT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.daymean <- stan_lmer(BBdelay ~  DayT + MeanT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.nightmean <- stan_lmer(BBdelay ~  NightT + MeanT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.daydiff <- stan_lmer(BBdelay ~  DayT + DIFF + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.nightdiff <- stan_lmer(BBdelay ~  NightT + DIFF + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.daydawn <- stan_lmer(BBdelay ~  DayT + DawnT + (1|Tree_ID/Cutting_code), data=betula, cores=4)
betula.nightdusk <- stan_lmer(BBdelay ~  NightT + DuskT + (1|Tree_ID/Cutting_code), data=betula, cores=4)


loo.betula.meanmax <- loo(betula.meanmax, save_psis = TRUE, k_threshold = 0.7)
loo.betula.maxdiff  <- loo(betula.maxdiff, save_psis = TRUE, k_threshold = 0.7)
loo.betula.diffdawn  <- loo(betula.diffdawn, save_psis = TRUE, k_threshold = 0.7)
loo.betula.dawndusk  <- loo(betula.dawndusk, save_psis = TRUE, k_threshold = 0.7)
loo.betula.diffdusk <- loo(betula.diffdusk, save_psis = TRUE, k_threshold = 0.7)
loo.betula.maxdawn  <- loo(betula.maxdawn, save_psis = TRUE, k_threshold = 0.7)
loo.betula.daymean <- loo(betula.daymean, save_psis = TRUE, k_threshold = 0.7)
loo.betula.nightmean  <- loo(betula.nightmean, save_psis = TRUE, k_threshold = 0.7)
loo.betula.daydiff <- loo(betula.daydiff, save_psis = TRUE, k_threshold = 0.7)
loo.betula.nightdiff <- loo(betula.nightdiff, save_psis = TRUE, k_threshold = 0.7)
loo.betula.daydawn <- loo(betula.daydawn, save_psis = TRUE, k_threshold = 0.7)
loo.betula.nightdusk  <- loo(betula.nightdusk, save_psis = TRUE, k_threshold = 0.7)

loo_compare(loo.betula.meanmax, loo.betula.maxdiff, loo.betula.diffdawn, loo.betula.dawndusk, 
	loo.betula.diffdusk, loo.betula.maxdawn, loo.betula.daymean, loo.betula.nightmean,
	loo.betula.daydiff, loo.betula.nightdiff, loo.betula.daydawn, loo.betula.nightdusk) 
```
