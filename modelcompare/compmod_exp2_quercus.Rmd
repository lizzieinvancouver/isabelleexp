## Started 14 October 2024
## By Lizzie

## What this code does ...
Following analyses_compmod_exp2.R some 
Using Stan and loo to do similar model comparison as Isabelle did in Scripts__expe2_model_comparison.R 
See https://mc-stan.org/loo/articles/loo2-example.html for info on loo ##
I have not fully reviewed the above page, I am mostly just following what I did in analyses_compmod_exp2.R ##

```{r}
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
```

Load libraries
```{r}
library(rstanarm)
```

Get the data
```{r}
setwd("~/Documents/git/projects/treegarden/misc/isabelle_expe/modelcompare")
d <- read.delim("input/data_expe2_v5.csv", header=TRUE, sep=";")
quercus <- subset(d, Species=="Quercus")
```

Run all the single predictor models 
```{r}
quercus.null <- stan_lmer(BBdelay ~ (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.day <- stan_lmer(BBdelay ~ DayT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.night <- stan_lmer(BBdelay ~ NightT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.max <- stan_lmer(BBdelay ~ MaxT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.min <- stan_lmer(BBdelay ~ MinT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.dawn <- stan_lmer(BBdelay ~ DawnT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.dusk <- stan_lmer(BBdelay ~ DuskT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.diff <- stan_lmer(BBdelay ~ DIFF + (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.mean <- stan_lmer(BBdelay ~  MeanT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)

loo.quercus.null <- loo(quercus.null, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.day <- loo(quercus.day, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.night <- loo(quercus.night, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.max <- loo(quercus.max, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.min <- loo(quercus.min, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.dawn <- loo(quercus.dawn, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.dusk <- loo(quercus.dusk, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.diff <- loo(quercus.diff, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.mean <- loo(quercus.mean, save_psis = TRUE, k_threshold = 0.7)
```

```{r}
loo_compare(loo.quercus.null, loo.quercus.day, loo.quercus.night, loo.quercus.max,
	loo.quercus.min, loo.quercus.dawn, loo.quercus.dusk, loo.quercus.diff, loo.quercus.mean) 
```

Now showing the model output ... 
Can look at estimate versus SD and also the 10-90% intervals

```{r}
summary(quercus.day, pars="DayT") 
summary(quercus.night, pars="NightT") 
summary(quercus.max, pars="MaxT") 
summary(quercus.min, pars="MinT") 
summary(quercus.dawn, pars="DawnT") 
summary(quercus.dusk, pars="DuskT") 
summary(quercus.diff, pars="DIFF") 
summary(quercus.mean, pars="MeanT") 
```

And look at the models with multiple predictors, for Qurcus also, I am just comparing to what Isabelle used
```{r}
quercus.maxmean <- stan_lmer(BBdelay ~  MaxT + MeanT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)
quercus.meandusk <- stan_lmer(BBdelay ~  DuskT + MeanT + (1|Tree_ID/Cutting_code), data=quercus, cores=4)

loo.quercus.maxmean <- loo(quercus.maxmean, save_psis = TRUE, k_threshold = 0.7)
loo.quercus.meandusk  <- loo(quercus.meandusk, save_psis = TRUE, k_threshold = 0.7)

loo_compare(loo.quercus.maxmean, loo.quercus.meandusk) 
```